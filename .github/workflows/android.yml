name: Build Android APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          build-essential \
          git \
          ffmpeg \
          libffi-dev \
          libssl-dev \
          python3-dev \
          autoconf \
          automake \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          cmake \
          libffi-dev \
          libltdl-dev \
          openjdk-17-jdk \
          unzip \
          zip \
          lld
    
    - name: Install Buildozer
      run: |
        pip install --upgrade pip
        pip install buildozer cython==0.29.36
    
    - name: Install application dependencies
      run: |
        pip install kivy yt-dlp
    
    - name: Set up Android SDK/NDK cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.buildozer
          ~/.android
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
    
    - name: Download FFmpeg binaries for Android
      run: |
        # Download pre-compiled static FFmpeg binaries for Android
        # Using binaries from Khang-NT/ffmpeg-binary-android (verified source)
        # Releases: https://github.com/Khang-NT/ffmpeg-binary-android/releases
        
        mkdir -p ffmpeg_bin/arm64-v8a
        mkdir -p ffmpeg_bin/armeabi-v7a
        
        # Download arm64-v8a (64-bit ARM) - FULL version with HTTPS support
        echo "Downloading FFmpeg for arm64-v8a..."
        curl -L "https://github.com/Khang-NT/ffmpeg-binary-android/releases/download/2018-07-31/arm64-v8a-full.tar.bz2" -o /tmp/ffmpeg-arm64.tar.bz2 2>/dev/null || true
        
        if [ -f /tmp/ffmpeg-arm64.tar.bz2 ] && [ -s /tmp/ffmpeg-arm64.tar.bz2 ]; then
          mkdir -p /tmp/ffmpeg-arm64
          tar -xjf /tmp/ffmpeg-arm64.tar.bz2 -C /tmp/ffmpeg-arm64 2>/dev/null || true
          find /tmp/ffmpeg-arm64 -name "ffmpeg" -type f -exec cp {} ffmpeg_bin/arm64-v8a/ \; 2>/dev/null || true
          find /tmp/ffmpeg-arm64 -name "ffprobe" -type f -exec cp {} ffmpeg_bin/arm64-v8a/ \; 2>/dev/null || true
        fi
        
        # Download armeabi-v7a (32-bit ARM) - using arm-v7n variant
        echo "Downloading FFmpeg for armeabi-v7a..."
        curl -L "https://github.com/Khang-NT/ffmpeg-binary-android/releases/download/2018-07-31/arm-v7n-full.tar.bz2" -o /tmp/ffmpeg-arm32.tar.bz2 2>/dev/null || true
        
        if [ -f /tmp/ffmpeg-arm32.tar.bz2 ] && [ -s /tmp/ffmpeg-arm32.tar.bz2 ]; then
          mkdir -p /tmp/ffmpeg-arm32
          tar -xjf /tmp/ffmpeg-arm32.tar.bz2 -C /tmp/ffmpeg-arm32 2>/dev/null || true
          find /tmp/ffmpeg-arm32 -name "ffmpeg" -type f -exec cp {} ffmpeg_bin/armeabi-v7a/ \; 2>/dev/null || true
          find /tmp/ffmpeg-arm32 -name "ffprobe" -type f -exec cp {} ffmpeg_bin/armeabi-v7a/ \; 2>/dev/null || true
        fi
        
        # Fallback: If arm32 failed, copy arm64 files (won't work on pure 32-bit devices)
        if [ ! -f ffmpeg_bin/armeabi-v7a/ffmpeg ] && [ -f ffmpeg_bin/arm64-v8a/ffmpeg ]; then
          echo "Warning: Using arm64 binaries as fallback for arm32"
          cp ffmpeg_bin/arm64-v8a/* ffmpeg_bin/armeabi-v7a/ 2>/dev/null || true
        fi
        
        # Make binaries executable
        chmod +x ffmpeg_bin/*/ffmpeg ffmpeg_bin/*/ffprobe 2>/dev/null || true
        
        # Show results
        echo "=== FFmpeg binaries ==="
        ls -la ffmpeg_bin/*/ 2>/dev/null || echo "WARNING: No binaries found!"
        
        # Verify at least arm64 binary exists
        if [ ! -f ffmpeg_bin/arm64-v8a/ffmpeg ]; then
          echo "ERROR: Failed to download FFmpeg binaries!"
          echo "The build will continue but FFmpeg features may not work."
        fi
    
    - name: Build APK with Buildozer
      run: |
        buildozer android debug
      env:
        ANDROIDSDK: ${{ github.workspace }}/.buildozer/android/platform/android-sdk
        ANDROIDNDK: ${{ github.workspace }}/.buildozer/android/platform/android-ndk-r25b
        ANDROIDAPI: "34"
        NDKAPI: "24"
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: youtube-downloader-apk
        path: bin/*.apk
        if-no-files-found: error
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
